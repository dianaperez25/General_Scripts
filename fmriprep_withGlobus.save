#!/usr/bin/bash

#SBATCH -A b1081
#SBATCH -p b1081
#SBATCH -t 168:00:00
#SBATCH --mem=0
#SBATCH -J fmriprep_lifespan_LS10
# Outputs ----------------------------------
#SBATCH --mail-user=dianaperez@u.northwestern.edu
#SBATCH --mail-type=ALL
# ------------------------------------------

# SUBJECT (make an input eventually)
subject="LS10"

# set up some directory information
BIDS_DIR="/projects/b1081/Lifespan"
DERIVS_DIR="derivatives/preproc_fmriprep-20.0.6"
WORK_DIR="/projects/b1081/singularity_images/work_dp"

# Transfer data to Quest
SOURCE_DIR="/Lifespan/BIDS/Nifti/sub-${subject}"
SOURCE_EPID="c4e4d798-640e-11ea-960d-0afc9e7dd773" # Endpoint ID for source (RDSS share)
DEST_DIR="/Lifespan/sub-${subject}"
DEST_EPID="01f757e6-5ff0-11ea-960c-0afc9e7dd773" # Endpoint ID for destination (QUEST allocation)

globus transfer ${SOURCE_EPID}:${SOURCE_DIR} ${DEST_EPID}:${DEST_DIR} --recursive --label "Trasnferring data to Quest for job"

# Prepare derivatives folder and work dirs
mkdir -p ${BIDS_DIR}/${DERIVS_DIR}
mkdir -p ${WORK_DIR}

# Load modules
module purge
module load singularity
echo "modules loaded" 

# To reuse freesurfer directories
mkdir -p ${BIDS_DIR}/derivatives/freesurfer-6.0.1
if [ ! -d ${BIDS_DIR}/${DERIVS_DIR}/freesurfer ]; then
    ln -s ${BIDS_DIR}/derivatives/freesurfer-6.0.1 ${BIDS_DIR}/${DERIVS_DIR}/freesurfer
fi

# remove IsRunning files from Freesurfer
find ${BIDS_DIR}/derivatives/freesurfer-6.0.1/sub-$subject/ -name "*IsRunning*" -type f -delete

# do singularity run
echo "Begin Preprocessing"

singularity run --cleanenv -B /projects/b1081:/projects/b1081 \
    /projects/b1081/singularity_images/fmriprep-20.0.6.simg \
    ${BIDS_DIR} \
    ${BIDS_DIR}/${DERIVS_DIR} \
    participant --participant-label ${subject} \
    -w ${WORK_DIR} --omp-nthreads 8 --nthreads 12 --mem_mb 3000 \
    --fs-license-file /projects/b1081/singularity_images/freesurfer_license.txt \
    --fs-subjects-dir ${BIDS_DIR}/derivatives/freesurfer-6.0.1 \
    --output-spaces MNI152NLin6Asym:res-2 \
    --ignore slicetiming --fd-spike-threshold 0.2

# Transfer job output from Quest


globus transfer ${SOURCE_EPID}:${SOURCE_DIR} ${DEST_EPID}:${DEST_DIR}   -  -s    --   recursive --label "Trasnferring data to Quest for job"
